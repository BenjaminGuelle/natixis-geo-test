<div class="p-4 max-w-2xl mx-auto space-y-4">
    <a routerLink="/search" class="hover:underline mb-4 inline-block">
        ← Retour à la recherche
    </a>

    <h1 class="text-2xl font-bold">
        @if (department()) {
            Communes de {{ department()?.name }}
            <span class="text-gray-500 font-normal text-lg ml-2">
              — {{ totalPopulation() | number }} habitants
            </span>
        } @else {
            Communes du département {{ departmentCode() }}
        }
    </h1>

    @if (!loading()) {
        <input type="text"
               [value]="filterQuery()"
               (input)="filterQuery.set($any($event.target).value)"
               placeholder="Filtrer les communes..."
               class="border border-gray-500 rounded px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-gray-300"
               data-testid="municipality-filter"
        />

        <div class="flex justify-between items-center">
            <p class="text-gray-500 text-sm">{{ municipalities().length }} communes</p>

            <div class="inline-flex rounded-lg border border-gray-300 overflow-hidden">
                <button (click)="toggleSort('name')"
                        [class]="sortField() === 'name' && sortOrder() !== 'none' ? 'bg-gray-700 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'"
                        class="px-4 py-2 text-sm font-medium transition-colors duration-200 cursor-pointer flex items-center gap-2"
                >
                    Nom
                    <span [class.opacity-0]="sortField() !== 'name' || sortOrder() === 'none'" class="text-xs w-3">
                        {{ sortOrder() === 'asc' ? '▲' : '▼' }}
                    </span>
                </button>
                <button (click)="toggleSort('population')"
                        [class]="sortField() === 'population' && sortOrder() !== 'none' ? 'bg-gray-700 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'"
                        class="px-4 py-2 text-sm font-medium transition-colors duration-200 cursor-pointer flex items-center gap-2 border-l border-gray-300"
                >
                    Population
                    <span [class.opacity-0]="sortField() !== 'population' || sortOrder() === 'none'" class="text-xs w-3">
                        {{ sortOrder() === 'asc' ? '▲' : '▼' }}
                    </span>
                </button>
            </div>
        </div>
    }

</div>

@if (loading()) {
    <div class="max-w-2xl mx-auto px-4 space-y-2">
        @for (i of [1, 2, 3, 4, 5, 6, 7, 8]; track i) {
            <div class="p-4 bg-gray-100 rounded animate-pulse h-14"></div>
        }
    </div>
} @else {
    <cdk-virtual-scroll-viewport itemSize="56" class="h-[calc(100vh-320px)] max-w-2xl mx-auto">
        <div *cdkVirtualFor="let municipality of municipalities(); trackBy: trackByCode"
             class="p-4 bg-gray-50 rounded mb-2 hover:bg-gray-100 transition-colors"
        >
            <span class="font-medium">{{ municipality.name }}</span>
            @if (municipality.population) {
                <span class="text-gray-500 text-sm ml-2">
                  ({{ municipality.population | number }} hab.)
                </span>
            }
        </div>
    </cdk-virtual-scroll-viewport>
}

@if (error()) {
    <div class="max-w-2xl mx-auto px-4 mb-4">
        <div class="p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 flex items-center gap-3">
            <span>{{ error() }}</span>
        </div>
    </div>
}